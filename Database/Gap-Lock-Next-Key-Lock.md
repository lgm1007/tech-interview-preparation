## 갭락(Gap Lock)과 넥스트키 락(Next-Key Lock)
### 유령 읽기 (Phantom Read)
* 유령 읽기는 트랜잭션이 동일한 조건의 쿼리를 반복 실행할 때, 나중에 실행된 쿼리에서 처음엔 존재하지 않았던 새로운 행이 나타나는 현상이다.
* 이는 주로 읽기 일관성 (Read Consistency) 을 유지하는 과정에서 발생할 수 있는 문제로, 데이터의 삽입과 삭제가 다른 트랜잭션에 의해 이루어질 때 발생한다.

### 갭락
* 특정 **인덱스의 값 사이의 공간**을 잠그는 락
* 갭락은 범위 내에 **특정 레코드가 존재하지 않을 때** 적용된다.
* 트랜잭션이 특정 범위 내에서 데이터의 삽입을 막아 유령 읽기 현상을 방지한다.
  * 예) 인덱스 값 10과 20 사이의 갭을 잠그면 이 범위 내에 새로운 레코드 15를 추가할 수 없다.

```sql
-- id 10, 20 가 저장된 orders 테이블
-- 트랜잭션 A 시작
START TRANSACTION;

-- 트랜잭션 A 10-20 사이의 갭 레코드 락 설정
SELECT * FROM orders WHERE order_id BETWEEN 10 AND 20 FOR UPDATE;

-- 트랜잭션 B 시작
START TRANSACTION;

-- 트랜잭션 B가 id 값 15인 데이터 삽입 시도 (갭락으로 인해 삽입이 차단되어 대기)
INSERT INTO orders (order_id, order_amount) VALUES (15, 100);
```

### 넥스트키 락
* 넥스트키 락은 레코드 락과 갭락을 결합한 형태로, 특정 인덱스 레코드와 그 주변의 갭을 동시에 잠그는 락이다.
* 레코드 자체의 변경과 함께 그 주변 공간의 변경도 동시에 제어 가능하다.
* 특정 레코드와 그 주변 공간을 잠그기 때문에, 다른 트랜잭션이 새로운 레코드를 삽입하여 유령 읽기를 발생시키는 것을 방지한다.

```sql
-- id 1, 2, 3 가 저장된 orders 테이블
-- 트랜잭션 A 시작
START TRANSACTION;

-- 트랜잭션 A amount = 200 인 orders_id = 2 레코드에 대한 레코드 락과 orders_id가 1-2, 2-3에 대한 갭락을 동시에 잠금으로써 넥스트키 락 설정
-- (InnoDB는 자동으로 넥스트키 락을 설정하여 레코드의 주변인 id = 1-2, 2-3 구간에도 갭락을 함께 설정함)
SELECT * FROM orders WHERE order_amount = 200 FOR UPDATE;

-- 트랜잭션 B 시작
START TRANSACTION;

-- 트랜잭션 B order_id = 4, orders_amount = 200인 레코드 삽입 시도 시, 넥스트키 락에 의해 차단되어 대기
-- (이미 존재하는 amount = 200 조건에 대한 새로운 레코드 삽입이므로, 유령 레코드로 간주되어 삽입 차단)
INSERT INTO orders (order_id, order_amont) VALUES (4, 200);
```

* 위 예제에서의 넥스트키 락이 걸리는 범위

| 레코드      |락 유형|설명|
|----------|---|---|
| `id = 1` |갭락|`1 < id < 2` 범위 잠금|
| `id = 2` |레코드 락|`id = 2` 레코드 잠금|
| `id = 3` |갭락|`2 < id < 3` 범위 잠금|

### 갭락과 넥스트키 락을 통한 유령 읽기 방지 메커니즘
* 트랜잭션 A가 특정 범위의 데이터를 조회할 때, 해당 범위에 대해 갭락 또는 넥스트키 락을 설정한다.
* 락이 설정된 범위 내에서는 트랜잭션 B가 새로운 레코드를 삽입하거나 기존 레코드를 수정하는 것이 차단된다.
* 이에, 트랜잭션 A가 다시 동일한 조건으로 조회하더라도 트랜잭션 B에 의해 **새로운 데이터가 삽입되지 않아 유령 읽기가 발생하지 않는다.**
